<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>학교 자체 입시 데이터 분석 대시보드</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
body{
  margin:0;
  font-family:"Noto Sans KR",system-ui;
  background:#f8fafc;
  color:#1e293b;
}
header{
  background:#2563eb;
  color:#fff;
  padding:18px 22px;
}
header h1{margin:0;font-size:24px;font-weight:800}
header p{margin:6px 0 0;font-size:14px;opacity:.9}

.container{max-width:1500px;margin:auto;padding:18px}

.card{
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:14px;
  padding:14px;
  margin-bottom:16px;
  box-shadow:0 2px 6px rgba(0,0,0,.04);
}
.card h2{margin:0 0 10px;font-size:16px}

.controls{
  display:flex;gap:10px;flex-wrap:wrap;align-items:center
}
button,label{
  background:#2563eb;color:#fff;
  border:none;border-radius:8px;
  padding:8px 14px;font-weight:600;cursor:pointer
}
input[type=file]{display:none}
select{
  padding:6px 10px;border-radius:6px;
  border:1px solid #cbd5f5;
}

.kpi-grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:14px
}
.kpi{
  font-size:26px;font-weight:800
}
.kpi-label{font-size:13px;color:#64748b}

.chart-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px
}

.table-wrap{
  max-height:360px;
  overflow:auto;
  border:1px solid #e5e7eb;
  border-radius:10px
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px
}
th,td{
  padding:8px;
  border-bottom:1px solid #e5e7eb;
  white-space:nowrap
}
th{
  background:#f1f5f9;
  position:sticky;top:0
}

@media(max-width:1100px){
  .kpi-grid{grid-template-columns:1fr 1fr}
  .chart-grid{grid-template-columns:1fr}
}
@media(max-width:600px){
  .kpi-grid{grid-template-columns:1fr}
}

canvas{height:320px!important}
</style>
</head>

<body>
<header>
  <h1>학교 자체 입시 데이터 분석 대시보드</h1>
  <p>엑셀 업로드 → 즉시 분석 (합격률 = 합격 + 충원합격)</p>
</header>

<div class="container">
<div class="card">
  <div class="controls">
    <label for="file">엑셀 업로드</label>
    <input id="file" type="file" accept=".xlsx,.xls">
    <select id="filterRegion"><option value="">지역(전체)</option></select>
    <select id="filterAdType"><option value="">전형유형(전체)</option></select>
    <select id="filterGrade"><option value="">등급대(전체)</option></select>
  </div>
</div>

<div class="kpi-grid">
  <div class="card"><div class="kpi" id="kpiTotal">0</div><div class="kpi-label">분석 건수</div></div>
  <div class="card"><div class="kpi" id="kpiRate">-</div><div class="kpi-label">합격률 %</div></div>
  <div class="card"><div class="kpi" id="kpiPass">0</div><div class="kpi-label">합격+충원</div></div>
  <div class="card"><div class="kpi" id="kpiFail">0</div><div class="kpi-label">불합격</div></div>
</div>

<div class="chart-grid">
  <div class="card"><h2>지역별 합격률</h2><canvas id="regionChart"></canvas></div>
  <div class="card"><h2>전형유형별 합격률</h2><canvas id="adTypeChart"></canvas></div>
</div>

<div class="card">
  <h2>등급대별 합격률</h2>
  <canvas id="gradeChart"></canvas>
</div>

<div class="card">
  <h2>사례 테이블 (차트 클릭 시 자동 필터)</h2>
  <div class="table-wrap">
    <table id="caseTable">
      <thead>
        <tr>
          <th>지역</th><th>대학명</th><th>전형유형</th>
          <th>모집단위</th><th>환산등급</th><th>합격결과</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<script>
Chart.register(ChartDataLabels);

let raw=[], filtered=[];
let chartFilter=null;

const el=id=>document.getElementById(id);
const isPass=r=>['합격','충원합격'].includes(r['합격결과']);

el('file').addEventListener('change',e=>{
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    const wb=XLSX.read(ev.target.result,{type:'binary'});
    raw=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:''});
    initFilters();
    apply();
  };
  r.readAsBinaryString(f);
});

['filterRegion','filterAdType','filterGrade'].forEach(id=>{
  el(id).addEventListener('change',()=>{chartFilter=null;apply();});
});

function initFilters(){
  fill('filterRegion',[...new Set(raw.map(r=>r['지역']).filter(Boolean))]);
  fill('filterAdType',[...new Set(raw.map(r=>r['전형유형']).filter(Boolean))]);
  fill('filterGrade',[...new Set(raw.map(r=>Math.floor(r['환산등급'])+'등급대').filter(v=>!v.includes('NaN')))]);
}
function fill(id,arr){
  const s=el(id); s.innerHTML='<option value="">전체</option>';
  arr.forEach(v=>s.innerHTML+=`<option>${v}</option>`);
}

function apply(){
  filtered=raw.filter(r=>{
    if(el('filterRegion').value && r['지역']!==el('filterRegion').value) return false;
    if(el('filterAdType').value && r['전형유형']!==el('filterAdType').value) return false;
    if(el('filterGrade').value){
      const g=Math.floor(r['환산등급'])+'등급대';
      if(g!==el('filterGrade').value) return false;
    }
    if(chartFilter){
      if(chartFilter.type==='region' && r['지역']!==chartFilter.value) return false;
      if(chartFilter.type==='adType' && r['전형유형']!==chartFilter.value) return false;
      if(chartFilter.type==='grade' && (Math.floor(r['환산등급'])+'등급대')!==chartFilter.value) return false;
    }
    return true;
  });
  updateKPI();
  drawCharts();
  drawTable();
}

function updateKPI(){
  el('kpiTotal').textContent=filtered.length;
  const v=filtered.filter(r=>r['합격결과']);
  const p=v.filter(r=>isPass(r)).length;
  el('kpiPass').textContent=p;
  el('kpiFail').textContent=v.length-p;
  el('kpiRate').textContent=v.length?((p/v.length)*100).toFixed(1):'-';
}

function drawTable(){
  const tb=el('caseTable').querySelector('tbody');
  tb.innerHTML='';
  filtered.slice(0,200).forEach(r=>{
    tb.innerHTML+=`
      <tr>
        <td>${r['지역']}</td>
        <td>${r['대학명']}</td>
        <td>${r['전형유형']}</td>
        <td>${r['모집단위']}</td>
        <td>${r['환산등급']}</td>
        <td>${r['합격결과']}</td>
      </tr>`;
  });
}

function drawCharts(){
  drawGroupChart('regionChart','지역','region');
  drawGroupChart('adTypeChart','전형유형','adType');
  drawGroupChart('gradeChart','환산등급','grade',true);
}

function drawGroupChart(cid,key,type,isGrade=false){
  const ctx=el(cid);
  if(ctx._c) ctx._c.destroy();
  const m={};
  filtered.forEach(r=>{
    const k=isGrade?Math.floor(r[key])+'등급대':r[key];
    if(!k) return;
    if(!m[k]) m[k]={p:0,t:0};
    if(r['합격결과']){
      m[k].t++;
      if(isPass(r)) m[k].p++;
    }
  });
  const labels=Object.keys(m);
  const rate=labels.map(k=>(m[k].t?m[k].p/m[k].t*100:0).toFixed(1));

  ctx._c=new Chart(ctx,{
    data:{
      labels,
      datasets:[
        {type:'bar',data:rate,label:'합격률',backgroundColor:'#93c5fd'},
        {type:'line',data:rate,label:'합격률 추세',borderColor:'#6366f1',tension:.3}
      ]
    },
    options:{
      plugins:{
        datalabels:{formatter:v=>v+'%',color:'#111'},
        legend:{position:'bottom'}
      },
      onClick:(e,els)=>{
        if(!els.length) return;
        chartFilter={type,value:labels[els[0].index]};
        apply();
      },
      scales:{y:{beginAtZero:true,max:100}}
    }
  });
}
</script>

</body>
</html>
