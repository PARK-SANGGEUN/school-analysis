<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>í•™êµ ìì²´ ì…ì‹œ ë°ì´í„° ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#0f172a;
  --panel:#111827;
  --card:#1f2933;
  --ink:#e5e7eb;
  --muted:#9ca3af;
  --accent:#38bdf8;
  --accent2:#22c55e;
  --accent3:#f59e0b;
  --danger:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;font-family:"Noto Sans KR",system-ui;background:#020617;color:var(--ink)}
header{
  background:linear-gradient(135deg,#2563eb,#22c55e);
  padding:22px;
  text-align:center;
}
header h1{
  margin:0;
  font-size:26px;
  font-weight:900;
  letter-spacing:-0.5px;
}
header p{
  margin:6px 0 0;
  font-size:13px;
  opacity:.9;
}
.wrap{max-width:1280px;margin:auto;padding:14px}
.grid{display:grid;gap:14px}
.grid.c2{grid-template-columns:repeat(2,1fr)}
.grid.c3{grid-template-columns:repeat(3,1fr)}
.grid.c4{grid-template-columns:repeat(4,1fr)}
@media(max-width:900px){
  .grid.c2,.grid.c3,.grid.c4{grid-template-columns:1fr}
}
.card{
  background:var(--card);
  border-radius:16px;
  padding:14px;
}
.card h2{
  margin:0 0 8px;
  font-size:15px;
  color:#e0f2fe;
}
button,label{
  background:#2563eb;
  color:#fff;
  border:0;
  padding:9px 14px;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
}
input[type=file]{display:none}
select{
  background:#020617;
  color:#e5e7eb;
  border:1px solid #334155;
  border-radius:8px;
  padding:6px;
}
canvas{height:320px!important;width:100%!important}
.small{font-size:12px;color:var(--muted)}
</style>
</head>

<body>

<header>
  <h1>í•™êµ ìì²´ ì…ì‹œ ë°ì´í„° ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
  <p>ì—‘ì…€ ì—…ë¡œë“œ Â· ì„œë²„ ì €ì¥ ì—†ìŒ Â· í•©ê²©/ì¶©ì›/ë¶ˆí•©ê²© í†µí•© ë¶„ì„</p>
</header>

<div class="wrap grid">

<!-- ì—…ë¡œë“œ -->
<div class="card">
  <label for="file">ğŸ“ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</label>
  <input id="file" type="file" accept=".xlsx,.xls">
  <p class="small">â€» Uì—´(í•©ê²©ê²°ê³¼) ê¸°ì¤€ ë¶„ì„ / ì¶©ì›í•©ê²© í¬í•¨</p>
</div>

<!-- í•„í„° -->
<div class="card grid c3">
  <div>
    <label>ì§€ì—­</label><br>
    <select id="region"></select>
  </div>
  <div>
    <label>ì „í˜•ìœ í˜•</label><br>
    <select id="adType"></select>
  </div>
  <div>
    <label>ë“±ê¸‰ ê¸°ì¤€</label><br>
    <select id="gradeBase">
      <option value="í™˜ì‚°ë“±ê¸‰">í™˜ì‚°ë“±ê¸‰</option>
      <option value="ì „êµê³¼">ì „êµê³¼</option>
      <option value="êµ­ì˜ìˆ˜">êµ­ì˜ìˆ˜</option>
      <option value="êµ­ì˜ìˆ˜ì‚¬">êµ­ì˜ìˆ˜ì‚¬</option>
      <option value="êµ­ì˜ìˆ˜ê³¼">êµ­ì˜ìˆ˜ê³¼</option>
    </select>
  </div>
</div>

<!-- í•©ê²© ê²°ê³¼ ë¹„ìœ¨ -->
<div class="card">
  <h2>í•©ê²© / ì¶©ì›í•©ê²© / ë¶ˆí•©ê²© ë¹„ìœ¨</h2>
  <canvas id="resultPie"></canvas>
</div>

<!-- ì§€ì—­ë³„ í•©ê²©ë¥  -->
<div class="card">
  <h2>ì§€ì—­ë³„ í•©ê²©ë¥  (ë¼ì¸)</h2>
  <canvas id="regionLine"></canvas>
</div>

<!-- ì§€ì—­ ì„ íƒ â†’ ëŒ€í•™ TOP10 -->
<div class="card">
  <h2>ì§€ì—­ ë‚´ ëŒ€í•™ë³„ í•©ê²©ë¥  TOP10</h2>
  <canvas id="regionUnivTop"></canvas>
</div>

<!-- ë¶ˆí•©ê²© ì‚¬ìœ  -->
<div class="card">
  <h2>ë¶ˆí•©ê²© ì‚¬ìœ  ë¶„ì„</h2>
  <canvas id="failReasonChart"></canvas>
</div>

<!-- í›„ë³´ìˆœìœ„ -->
<div class="card">
  <h2>í›„ë³´ìˆœìœ„ ë¶„í¬ (ì¶”í•© íë¦„)</h2>
  <canvas id="waitChart"></canvas>
</div>

<!-- ë“±ê¸‰ ë¶„í¬ -->
<div class="card">
  <h2>í•©ê²©ì ë“±ê¸‰ ë¶„í¬ (ë°•ìŠ¤í”Œë¡¯ ëŠë‚Œ)</h2>
  <canvas id="gradeDist"></canvas>
</div>

</div>

<script>
let rows=[];
const $=id=>document.getElementById(id);

$("file").addEventListener("change",async e=>{
  const f=e.target.files[0];
  const wb=XLSX.read(await f.arrayBuffer(),{type:"array"});
  rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});
  initFilters();
  drawAll();
});

function initFilters(){
  fill("region",[...new Set(rows.map(r=>r["ì§€ì—­"]).filter(Boolean))]);
  fill("adType",[...new Set(rows.map(r=>r["ì „í˜•ìœ í˜•"]).filter(Boolean))]);
}
function fill(id,list){
  const s=$(id);
  s.innerHTML="<option value=''>ì „ì²´</option>";
  list.forEach(v=>{
    s.innerHTML+=`<option>${v}</option>`;
  });
}

["region","adType","gradeBase"].forEach(id=>{
  $(id).addEventListener("change",drawAll);
});

function filtered(){
  return rows.filter(r=>{
    if($("region").value && r["ì§€ì—­"]!==$("region").value) return false;
    if($("adType").value && r["ì „í˜•ìœ í˜•"]!==$("adType").value) return false;
    return true;
  });
}

function drawAll(){
  const data=filtered();
  drawResultPie(data);
  drawRegionLine(data);
  drawRegionUnivTop(data);
  drawFailReason(data);
  drawWait(data);
  drawGradeDist(data);
}

function isPass(r){return r==="í•©ê²©"||r==="ì¶©ì›í•©ê²©";}

function drawResultPie(data){
  const c={í•©ê²©:0,ì¶©ì›í•©ê²©:0,ë¶ˆí•©ê²©:0};
  data.forEach(r=>{
    const v=r["í•©ê²©ê²°ê³¼"];
    if(c[v]!=null)c[v]++;
  });
  chart("resultPie","doughnut",
    Object.keys(c),
    [{data:Object.values(c),backgroundColor:["#22c55e","#38bdf8","#ef4444"]}]
  );
}

function drawRegionLine(data){
  const m={};
  data.forEach(r=>{
    if(!m[r["ì§€ì—­"]])m[r["ì§€ì—­"]]={p:0,t:0};
    if(r["í•©ê²©ê²°ê³¼"]){
      m[r["ì§€ì—­"]].t++;
      if(isPass(r["í•©ê²©ê²°ê³¼"]))m[r["ì§€ì—­"]].p++;
    }
  });
  chart("regionLine","line",
    Object.keys(m),
    [{label:"í•©ê²©ë¥ (%)",data:Object.values(m).map(v=>(v.p/v.t*100).toFixed(1)),
      borderColor:"#38bdf8",fill:true}]
  );
}

function drawRegionUnivTop(data){
  if(!$("region").value){$("regionUnivTop").replaceWith($("regionUnivTop").cloneNode());return;}
  const m={};
  data.forEach(r=>{
    if(!m[r["ëŒ€í•™ëª…"]])m[r["ëŒ€í•™ëª…"]]={p:0,t:0};
    if(r["í•©ê²©ê²°ê³¼"]){
      m[r["ëŒ€í•™ëª…"]].t++;
      if(isPass(r["í•©ê²©ê²°ê³¼"]))m[r["ëŒ€í•™ëª…"]].p++;
    }
  });
  const arr=Object.entries(m).map(([k,v])=>[k,(v.p/v.t*100)||0])
    .sort((a,b)=>b[1]-a[1]).slice(0,10);
  chart("regionUnivTop","bar",
    arr.map(a=>a[0]),
    [{data:arr.map(a=>a[1]),backgroundColor:"#22c55e"}]
  );
}

function drawFailReason(data){
  const m={};
  data.forEach(r=>{
    if(r["ë¶ˆí•©ê²©ì‚¬ìœ "])m[r["ë¶ˆí•©ê²©ì‚¬ìœ "]]=(m[r["ë¶ˆí•©ê²©ì‚¬ìœ "]]||0)+1;
  });
  chart("failReasonChart","bar",
    Object.keys(m),
    [{data:Object.values(m),backgroundColor:"#f59e0b"}]
  );
}

function drawWait(data){
  const m={};
  data.forEach(r=>{
    if(r["í›„ë³´ìˆœìœ„"])m[r["í›„ë³´ìˆœìœ„"]]=(m[r["í›„ë³´ìˆœìœ„"]]||0)+1;
  });
  chart("waitChart","line",
    Object.keys(m),
    [{data:Object.values(m),borderColor:"#a855f7"}]
  );
}

function drawGradeDist(data){
  const base=$("gradeBase").value;
  const arr=data.filter(r=>isPass(r["í•©ê²©ê²°ê³¼"]))
    .map(r=>+r[base]).filter(v=>v);
  arr.sort((a,b)=>a-b);
  chart("gradeDist","line",
    arr.map((_,i)=>i+1),
    [{data:arr,borderColor:"#22c55e",fill:true}]
  );
}

function chart(id,type,labels,datasets){
  const c=$(id);
  if(c._chart)c._chart.destroy();
  c._chart=new Chart(c,{type,data:{labels,datasets},
    options:{responsive:true,plugins:{legend:{display:type!=="line"}}}});
}
</script>
</body>
</html>
