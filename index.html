function applyAll(){
  VIEW=RAW.filter(r=>{
    if(val('fSchool')&&r.school!==val('fSchool')) return false;
    if(val('fRegion')&&r.region!==val('fRegion')) return false;
    if(val('fUniv')&&r.univ!==val('fUniv')) return false;
    if(val('fAdType')&&r.adType!==val('fAdType')) return false;

    if(val('fGradeType')&&val('fGradeBand')){
      let g=null;
      if(val('fGradeType')==='í™˜ì‚°ë“±ê¸‰') g=r.grade;
      if(val('fGradeType')==='êµ­ì˜ìˆ˜') g=r.g_kym;
      if(val('fGradeType')==='êµ­ì˜ìˆ˜ì‚¬') g=r.g_kysa;
      if(val('fGradeType')==='êµ­ì˜ìˆ˜ê³¼') g=r.g_kygw;
      if(g==null||Math.floor(g)!==Number(val('fGradeBand'))) return false;
    }

    if(activeFilter.type){
      if(activeFilter.type==='region'&&r.region!==activeFilter.value) return false;
      if(activeFilter.type==='adType'&&r.adType!==activeFilter.value) return false;
      if(activeFilter.type==='univ'&&r.univ!==activeFilter.value) return false;
    }
    return true;
  });

  updateKPI();
  drawCharts();
  drawTable();
}

function updateKPI(){
  const judged=VIEW.filter(r=>r.result);
  const pass=judged.filter(isPass).length;
  el('kpiTotal').textContent=VIEW.length;
  el('kpiPass').textContent=pass;
  el('kpiFail').textContent=judged.length-pass;
  el('kpiRate').textContent=judged.length?((pass/judged.length)*100).toFixed(1):'-';
}

function groupBy(key){
  const m={};
  VIEW.forEach(r=>{
    const k=r[key]; if(!k) return;
    if(!m[k]) m[k]={p:0,w:0,f:0,t:0};
    if(r.result){
      m[k].t++;
      if(r.result==='í•©ê²©') m[k].p++;
      else if(r.result==='ì¶©ì›í•©ê²©') m[k].w++;
      else if(r.result==='ë¶ˆí•©ê²©') m[k].f++;
    }
  });
  return Object.entries(m).map(([k,v])=>({
    label:k, rate:v.t?((v.p+v.w)/v.t*100):0
  }));
}

function drawCharts(){
  drawBarLine('regionChart',groupBy('region'),'region');
  drawBarLine('adTypeChart',groupBy('adType'),'adType');
  drawUnivTop();
}

function drawBarLine(id,data,type){
  if(charts[id]) charts[id].destroy();
  charts[id]=new Chart(el(id),{
    data:{
      labels:data.map(d=>d.label),
      datasets:[
        {type:'bar',data:data.map(d=>d.rate),backgroundColor:'#93c5fd'},
        {type:'line',data:data.map(d=>d.rate),borderColor:'#6366f1',tension:.3}
      ]
    },
    options:{
      plugins:{datalabels:{formatter:v=>v.toFixed(1)+'%'}},
      onClick:(e,els)=>{
        if(!els.length) return;
        activeFilter={type,value:data[els[0].index].label};
        applyAll();
      },
      scales:{y:{beginAtZero:true,max:100}}
    }
  });
}

function drawUnivTop(){
  const data=groupBy('univ').sort((a,b)=>b.rate-a.rate).slice(0,10);
  if(charts.univ) charts.univ.destroy();
  charts.univ=new Chart(el('univTopChart'),{
    data:{
      labels:data.map(d=>d.label),
      datasets:[{type:'bar',data:data.map(d=>d.rate),backgroundColor:'#c4b5fd'}]
    },
    options:{
      indexAxis:'y',
      plugins:{datalabels:{formatter:v=>v.toFixed(1)+'%'}},
      onClick:(e,els)=>{
        if(!els.length) return;
        activeFilter={type:'univ',value:data[els[0].index].label};
        applyAll();
      },
      scales:{x:{beginAtZero:true,max:100}}
    }
  });
}

function drawTable(){
  const body=document.querySelector('#caseTable tbody');
  body.innerHTML='';
  VIEW.forEach(r=>{
    const tr=document.createElement('tr');
    [
      r.school,r.region,r.univ,r.adType,r.adDetail,r.major,
      r.grade,r.g_kym,r.g_kysa,r.g_kygw,r.result
    ].forEach(v=>{
      const td=document.createElement('td');
      td.textContent=v??'';
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}

setStatus('ëŒ€ê¸°(ì—‘ì…€ ì—…ë¡œë“œ í•„ìš”)');
</script>

</body>
</html>
<script>
Chart.register(ChartDataLabels);

const DEFAULT_SCHOOL = 'ì¶˜ì²œê³ ë“±í•™êµ';

// Q,S,U ì—´ ê°•ì œ ì¸ë±ìŠ¤ (0-based)
const COL_Q = XLSX.utils.decode_col('Q'); // 16
const COL_S = XLSX.utils.decode_col('S'); // 18
const COL_U = XLSX.utils.decode_col('U'); // 20

// ì„±ëŠ¥: ì›ë³¸/ì •ê·œí™”/í•„í„°ê²°ê³¼ ìºì‹œ
let RAW = [];       // normalized rows
let VIEW = [];      // filtered rows
let VIEW2 = [];     // filtered + search
let charts = {};
let activeFilter = null;

let paging = { page: 1, size: 50 };

const el = (id)=>document.getElementById(id);
const uniq = (arr)=>[...new Set(arr.filter(v=>v!=='' && v!=null))];
const safe = (v)=> (v==null ? '' : String(v));
const num = (v)=> {
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
};

function setStatus(msg){
  el('statusText').textContent = msg;
}

function showChip(text){
  const chip = el('activeChip');
  chip.style.display = 'inline-flex';
  chip.firstChild.textContent = '';
  chip.childNodes[0].textContent = text; // ì²« í…ìŠ¤íŠ¸ ë…¸ë“œ
}

function hideChip(){
  el('activeChip').style.display='none';
  activeFilter = null;
}

el('clearChipBtn').addEventListener('click', ()=>{
  hideChip();
  applyAll();
});

// ====== ì—…ë¡œë“œ ======
el('fileInput').addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  setStatus('ì—‘ì…€ ì½ëŠ” ì¤‘...');
  const fr = new FileReader();
  fr.onload = (ev)=>{
    try{
      const wb = XLSX.read(ev.target.result, {type:'binary'});
      const ws = wb.Sheets[wb.SheetNames[0]];

      // header:1 => 2D array (ì—´ ì¸ë±ìŠ¤ë¡œ ì ‘ê·¼ ê°€ëŠ¥)
      const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
      if(rows.length < 2){
        setStatus('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤(í—¤ë”/í–‰ í™•ì¸ í•„ìš”).');
        return;
      }

      const header = rows[0].map(h=>safe(h).trim());
      const idx = indexMap(header);

      RAW = rows.slice(1).map((r)=>normalizeRowFromArray(r, idx, header));

      initFilters();
      // ì´ˆê¸° í•™êµ ê³ ì •: ì¶˜ì²œê³ ë“±í•™êµê°€ ìˆìœ¼ë©´ ì„ íƒ
      const schSel = el('fSchool');
      if([...schSel.options].some(o=>o.value===DEFAULT_SCHOOL)){
        schSel.value = DEFAULT_SCHOOL;
      }
      paging.page = 1;
      applyAll();

      setStatus(`ë¶„ì„ ì™„ë£Œ (${RAW.length}í–‰)`);
    }catch(err){
      console.error(err);
      setStatus('ì—‘ì…€ ë¶„ì„ ì‹¤íŒ¨(íŒŒì¼/ì‹œíŠ¸ í™•ì¸ í•„ìš”).');
    }
  };
  fr.readAsBinaryString(f);
});

// ====== í—¤ë” ì¸ë±ìŠ¤ë§µ (ì¤‘ë³µ í—¤ë” ëŒ€ë¹„: ì²« ë²ˆì§¸ë§Œ ì‚¬ìš©) ======
function indexMap(header){
  const m = {};
  header.forEach((h,i)=>{
    const k = h;
    if(!k) return;
    if(m[k] == null) m[k] = i;
  });
  return m;
}

// ====== ì •ê·œí™”: ì—´ ì´ë¦„ + (Q/S/U ê°•ì œ) ======
function normalizeRowFromArray(row, idx, header){
  // í—¤ë” ê¸°ë°˜ í•„ë“œ(ê°€ëŠ¥í•˜ë©´)
  const getByName = (name)=> {
    const i = idx[name];
    return i==null ? '' : row[i];
  };

  // Q/S/U ê°•ì œ
  const scoreQ = row[COL_Q];
  const gradeS = row[COL_S];
  const resultU = row[COL_U];

  const school = safe(getByName('ê³ êµëª…') || row[0]).trim();
  const region = safe(getByName('ì§€ì—­')).trim();
  const univ   = safe(getByName('ëŒ€í•™ëª…')).trim();
  const adType = safe(getByName('ì „í˜•ìœ í˜•') || getByName('ì „í˜•')).trim();
  const detail = safe(getByName('ì„¸ë¶€ìœ í˜•')).trim();
  const major  = safe(getByName('ëª¨ì§‘ë‹¨ìœ„')).trim();

  const failReason = safe(getByName('ë¶ˆí•©ê²©ì‚¬ìœ ')).trim();
  const waitRank   = safe(getByName('í›„ë³´ìˆœìœ„')).trim();

  // ë“±ê¸‰ë“¤(ì—´ ì´ë¦„ ê·¸ëŒ€ë¡œ)
  const g_kym  = num(getByName('êµ­ì˜ìˆ˜'));
  const g_kysa = num(getByName('êµ­ì˜ìˆ˜ì‚¬'));
  const g_kygw = num(getByName('êµ­ì˜ìˆ˜ê³¼'));

  return {
    // í•µì‹¬ í•„ë“œ
    school, region, univ, adType, detail, major,

    // Q/S/U ê°•ì œ í•„ë“œ
    score: num(scoreQ),
    grade: num(gradeS),
    result: safe(resultU).trim(),

    // ì¶”ê°€
    failReason,
    waitRank,

    // ë“±ê¸‰ ì˜µì…˜
    g_kym, g_kysa, g_kygw,

    // ì›ë³¸(í…Œì´ë¸” í‘œì‹œìš©)
    _raw: row
  };
}

// ====== í•„í„° ì´ˆê¸°í™” ======
function fillSelect(id, arr){
  const s = el(id);
  const cur = s.value;
  s.innerHTML = '<option value="">ì „ì²´</option>';
  arr.forEach(v=>{
    const o = document.createElement('option');
    o.value = v; o.textContent = v;
    s.appendChild(o);
  });
  // ê°€ëŠ¥í•˜ë©´ ì´ì „ ì„ íƒ ìœ ì§€
  if([...s.options].some(o=>o.value===cur)) s.value = cur;
}

function initFilters(){
  fillSelect('fSchool', uniq(RAW.map(r=>r.school)));
  fillSelect('fRegion', uniq(RAW.map(r=>r.region)));
  fillSelect('fUniv',   uniq(RAW.map(r=>r.univ)));
  fillSelect('fAdType', uniq(RAW.map(r=>r.adType)));
}

// í•„í„° ë³€ê²½ ì‹œ
['fSchool','fRegion','fUniv','fAdType','fGradeType','fGradeBand'].forEach(id=>{
  el(id).addEventListener('change', ()=>{
    activeFilter = null;
    el('activeChip').style.display='none';
    paging.page = 1;
    applyAll();
  });
});

// ê²€ìƒ‰/í˜ì´ì§€
el('qSearch').addEventListener('input', ()=>{
  paging.page = 1;
  applyAll();
});
el('pageSize').addEventListener('change', ()=>{
  paging.size = Number(el('pageSize').value);
  paging.page = 1;
  applyAll();
});
el('prevBtn').addEventListener('click', ()=>{
  if(paging.page>1){ paging.page--; renderTable(); }
});
el('nextBtn').addEventListener('click', ()=>{
  const maxPage = Math.max(1, Math.ceil(VIEW2.length / paging.size));
  if(paging.page < maxPage){ paging.page++; renderTable(); }
});

// ====== í•„í„° ì ìš©(ì„±ëŠ¥: í•œë²ˆë§Œ ìˆœíšŒ) ======
function getGradeByType(r){
  const t = el('fGradeType').value;
  if(t==='í™˜ì‚°ë“±ê¸‰') return r.grade;
  if(t==='êµ­ì˜ìˆ˜') return r.g_kym;
  if(t==='êµ­ì˜ìˆ˜ì‚¬') return r.g_kysa;
  if(t==='êµ­ì˜ìˆ˜ê³¼') return r.g_kygw;
  return null;
}

function applyAll(){
  const sch = el('fSchool').value;
  const reg = el('fRegion').value;
  const unv = el('fUniv').value;
  const adt = el('fAdType').value;
  const gt  = el('fGradeType').value;
  const gb  = el('fGradeBand').value;
  const q   = el('qSearch').value.trim().toLowerCase();

  VIEW = [];
  for(const r of RAW){
    if(sch && r.school!==sch) continue;
    if(reg && r.region!==reg) continue;
    if(unv && r.univ!==unv) continue;
    if(adt && r.adType!==adt) continue;

    if(gt && gb){
      const g = getGradeByType(r);
      if(g==null) continue;
      if(Math.floor(g) !== Number(gb)) continue;
    }

    if(activeFilter){
      if(activeFilter.type==='region' && r.region!==activeFilter.value) continue;
      if(activeFilter.type==='adType' && r.adType!==activeFilter.value) continue;
      if(activeFilter.type==='univ' && r.univ!==activeFilter.value) continue;
      if(activeFilter.type==='gradeBand'){
        const g = getGradeByType(r);
        if(g==null) continue;
        if((Math.floor(g)+'') !== activeFilter.value) continue;
      }
      if(activeFilter.type==='failReason' && r.failReason!==activeFilter.value) continue;
    }

    VIEW.push(r);
  }

  if(!q){
    VIEW2 = VIEW;
  }else{
    // ê²€ìƒ‰(ê°€ë²¼ìš´ í•„ë“œë§Œ)
    VIEW2 = VIEW.filter(r=>{
      const blob = `${r.univ} ${r.major} ${r.adType} ${r.detail} ${r.region} ${r.result}`.toLowerCase();
      return blob.includes(q);
    });
  }

  updateKPI();
  drawAllCharts();
  renderTable();
}

function updateKPI(){
  el('kpiRows').textContent = VIEW2.length;

  let judged=0, pass=0, wait=0, fail=0;
  for(const r of VIEW2){
    if(!r.result) continue;
    judged++;
    if(r.result==='í•©ê²©') pass++;
    else if(r.result==='ì¶©ì›í•©ê²©') wait++;
    else if(r.result==='ë¶ˆí•©ê²©') fail++;
  }
  el('kpiJudged').textContent = judged;
  el('kpiPass').textContent = pass;
  el('kpiWait').textContent = wait;
  el('kpiFail').textContent = fail;
  el('kpiRate').textContent = judged ? (((pass+wait)/judged)*100).toFixed(1)+'%' : '-';
}

// ===== í…Œì´ë¸” í—¤ë”(ì›í•˜ëŠ” ì»¬ëŸ¼ ìœ„ì£¼) =====
const TABLE_COLS = [
  {k:'school', t:'ê³ êµëª…'},
  {k:'region', t:'ì§€ì—­'},
  {k:'univ', t:'ëŒ€í•™ëª…'},
  {k:'adType', t:'ì „í˜•ìœ í˜•'},
  {k:'detail', t:'ì„¸ë¶€ìœ í˜•'},
  {k:'major', t:'ëª¨ì§‘ë‹¨ìœ„'},
  {k:'score', t:'í™˜ì‚°ì ìˆ˜(Q)'},
  {k:'grade', t:'í™˜ì‚°ë“±ê¸‰(S)'},
  {k:'g_kym', t:'êµ­ì˜ìˆ˜'},
  {k:'g_kysa', t:'êµ­ì˜ìˆ˜ì‚¬'},
  {k:'g_kygw', t:'êµ­ì˜ìˆ˜ê³¼'},
  {k:'result', t:'í•©ê²©ê²°ê³¼(U)'},
  {k:'failReason', t:'ë¶ˆí•©ê²©ì‚¬ìœ '},
  {k:'waitRank', t:'í›„ë³´ìˆœìœ„'}
];

(function initTableHeader(){
  const tr = el('theadRow');
  tr.innerHTML='';
  TABLE_COLS.forEach(c=>{
    const th=document.createElement('th');
    th.textContent=c.t;
    tr.appendChild(th);
  });
})();
/* ===============================
   PART 4-1 : ì„±ëŠ¥ ìµœì í™” & ìœ í‹¸
================================ */

// ë Œë”ë§ ìµœì í™”ìš© requestAnimationFrame
function raf(fn){
  window.requestAnimationFrame
    ? requestAnimationFrame(fn)
    : setTimeout(fn,0);
}

// ì°¨íŠ¸ ì•ˆì „ ì œê±°
function safeDestroy(k){
  if(charts[k]){
    charts[k].destroy();
    charts[k]=null;
  }
}

// í•©ê²© íŒì • (Uì—´)
function isPass(r){
  return r.result === 'í•©ê²©' || r.result === 'ì¶©ì›í•©ê²©';
}

// ì´ˆê¸° í•™êµ ê³ ì • (ì¶˜ì²œê³ ë“±í•™êµ)
function applyDefaultSchool(){
  const s = document.getElementById('fSchool');
  if(!s) return;
  const opt = [...s.options].find(o=>o.value.includes('ì¶˜ì²œ'));
  if(opt){
    s.value = opt.value;
  }
}
/* ===============================
   PART 4-2 : í•„í„° ì ìš© (ë ‰ ë°©ì§€)
================================ */

function applyAll(){
  raf(()=>{
    VIEW = RAW.filter(r=>{
      if(val('fSchool') && r.school !== val('fSchool')) return false;
      if(val('fRegion') && r.region !== val('fRegion')) return false;
      if(val('fUniv') && r.univ !== val('fUniv')) return false;
      if(val('fAdType') && r.adType !== val('fAdType')) return false;

      // ë“±ê¸‰ í•„í„° (Sì—´ í™˜ì‚°ë“±ê¸‰)
      if(val('fGradeType') && val('fGradeBand')){
        let g = null;
        if(val('fGradeType')==='í™˜ì‚°ë“±ê¸‰') g = r.grade;       // Sì—´
        if(val('fGradeType')==='êµ­ì˜ìˆ˜') g = r.g_kym;
        if(val('fGradeType')==='êµ­ì˜ìˆ˜ì‚¬') g = r.g_kysa;
        if(val('fGradeType')==='êµ­ì˜ìˆ˜ê³¼') g = r.g_kygw;

        if(g==null) return false;
        if(Math.floor(g) !== Number(val('fGradeBand'))) return false;
      }

      // ì°¨íŠ¸ í´ë¦­ í•„í„°
      if(activeFilter.type){
        if(activeFilter.type==='region' && r.region!==activeFilter.value) return false;
        if(activeFilter.type==='adType' && r.adType!==activeFilter.value) return false;
        if(activeFilter.type==='univ' && r.univ!==activeFilter.value) return false;
      }
      return true;
    });

    updateKPI();
    drawCharts();
    drawTable();
  });
}
/* ===============================
   PART 4-3 : ì§‘ê³„ & ì°¨íŠ¸
================================ */

function groupBy(key){
  const m={};
  for(const r of VIEW){
    const k=r[key];
    if(!k) continue;
    if(!m[k]) m[k]={p:0,w:0,f:0,t:0};

    if(r.result){
      m[k].t++;
      if(r.result==='í•©ê²©') m[k].p++;
      else if(r.result==='ì¶©ì›í•©ê²©') m[k].w++;
      else if(r.result==='ë¶ˆí•©ê²©') m[k].f++;
    }
  }
  return Object.entries(m).map(([k,v])=>({
    label:k,
    rate: v.t ? ((v.p+v.w)/v.t*100) : 0,
    ...v
  }));
}

function drawCharts(){
  drawBarLine('regionChart', groupBy('region'), 'region');
  drawBarLine('adTypeChart', groupBy('adType'), 'adType');
  drawUnivTop();
}

function drawBarLine(id,data,type){
  safeDestroy(id);

  charts[id] = new Chart(el(id),{
    data:{
      labels:data.map(d=>d.label),
      datasets:[
        {
          type:'bar',
          label:'í•©ê²©ë¥ (%)',
          data:data.map(d=>d.rate),
          backgroundColor:'#60a5fa'
        },
        {
          type:'line',
          label:'í•©ê²©ë¥  ì¶”ì„¸',
          data:data.map(d=>d.rate),
          borderColor:'#1d4ed8',
          tension:.3,
          pointRadius:4
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{position:'bottom'},
        datalabels:{
          anchor:'end',
          align:'top',
          formatter:v=>v.toFixed(1)+'%',
          font:{weight:'bold'}
        }
      },
      scales:{
        y:{beginAtZero:true,max:100,title:{display:true,text:'í•©ê²©ë¥  %'}},
        x:{ticks:{maxRotation:30,minRotation:0}}
      },
      onClick:(e,els)=>{
        if(!els.length) return;
        activeFilter={type,value:data[els[0].index].label};
        applyAll();
      }
    }
  });
}
/* ===============================
   PART 4-4 : TOP10 & í…Œì´ë¸”
================================ */

function drawUnivTop(){
  safeDestroy('univ');

  const data = groupBy('univ')
    .sort((a,b)=>b.rate-a.rate)
    .slice(0,10);

  charts.univ = new Chart(el('univTopChart'),{
    data:{
      labels:data.map(d=>d.label),
      datasets:[
        {
          type:'bar',
          label:'ëŒ€í•™ë³„ í•©ê²©ë¥  TOP10',
          data:data.map(d=>d.rate),
          backgroundColor:'#a78bfa'
        }
      ]
    },
    options:{
      indexAxis:'y',
      plugins:{
        legend:{display:false},
        datalabels:{
          formatter:v=>v.toFixed(1)+'%',
          anchor:'end',
          align:'right'
        }
      },
      scales:{
        x:{beginAtZero:true,max:100}
      },
      onClick:(e,els)=>{
        if(!els.length) return;
        activeFilter={type:'univ',value:data[els[0].index].label};
        applyAll();
      }
    }
  });
}

function drawTable(){
  const body = document.querySelector('#caseTable tbody');
  body.innerHTML='';

  const frag = document.createDocumentFragment();
  VIEW.slice(0,300).forEach(r=>{   // ğŸ”¥ ë ‰ ë°©ì§€ (300í–‰ ì œí•œ)
    const tr=document.createElement('tr');
    [
      r.school,r.region,r.univ,r.adType,r.adDetail,r.major,
      r.score,r.grade,r.result
    ].forEach(v=>{
      const td=document.createElement('td');
      td.textContent=v??'';
      tr.appendChild(td);
    });
    frag.appendChild(tr);
  });
  body.appendChild(frag);
}

// ìµœì´ˆ ìƒíƒœ
setStatus('ëŒ€ê¸°(ì—‘ì…€ ì—…ë¡œë“œ í•„ìš”)');
