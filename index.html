<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>í•™êµ ìì²´ ì…ì‹œ ë°ì´í„° ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#050816;
      --bg1:#0b1026;
      --card:#0f1736;
      --card2:#0b1331;
      --line:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.70);

      --ok:#22c55e;        /* í•©ê²© */
      --wait:#38bdf8;      /* ì¶©ì›í•©ê²© */
      --bad:#ef4444;       /* ë¶ˆí•©ê²© */
      --accent:#a855f7;    /* í¬ì¸íŠ¸ */
      --warn:#f59e0b;      /* ê²½ê³ /ì‚¬ìœ  */
      --cyan:#06b6d4;

      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --r: 18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% 0%, rgba(56,189,248,.18), transparent 60%),
        radial-gradient(900px 500px at 80% 10%, rgba(168,85,247,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: rgba(5,8,22,.68);
      border-bottom: 1px solid var(--line);
    }
    .headerWrap{
      max-width: 1280px;
      margin: 0 auto;
      padding: 16px 16px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
    }
    .titleBlock h1{
      margin:0;
      font-size: 22px;
      font-weight: 900;
      letter-spacing:-0.6px;
      background: linear-gradient(135deg, #60a5fa, #22c55e 55%, #a855f7);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .titleBlock .sub{
      margin-top:6px;
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }
    .schoolTag{
      margin-top:8px;
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.04);
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .chip b{ color: var(--text); font-weight:800; }

    .actions{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
      align-items:center;
    }
    .btn, label.btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      box-shadow: 0 8px 20px rgba(0,0,0,.18);
      text-decoration:none;
      user-select:none;
    }
    .btn.primary, label.btn.primary{
      border:none;
      background: linear-gradient(135deg, #2563eb, #22c55e);
      box-shadow: 0 14px 28px rgba(34,197,94,.12), 0 14px 28px rgba(37,99,235,.12);
    }
    .btn.ghost{
      background: rgba(255,255,255,.04);
    }
    input[type="file"]{ display:none; }

    .wrap{
      max-width: 1280px;
      margin: 0 auto;
      padding: 16px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .grid{ display:grid; gap:14px; }
    .grid.kpi{ grid-template-columns: repeat(4, minmax(0,1fr)); }
    .grid.two{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid.three{ grid-template-columns: repeat(3, minmax(0,1fr)); }

    @media (max-width: 1060px){
      .grid.kpi{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .grid.three{ grid-template-columns: 1fr; }
    }
    @media (max-width: 860px){
      .grid.two{ grid-template-columns: 1fr; }
      .headerWrap{ flex-direction:column; align-items:stretch; }
      .actions{ justify-content:flex-start; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 14px;
      overflow:hidden;
    }
    .cardHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .cardHeader h2{
      margin:0;
      font-size: 14px;
      font-weight:900;
      letter-spacing:-0.2px;
    }
    .help{
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }

    .filters{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    }
    select, input[type="text"]{
      background: rgba(3,8,24,.55);
      color: var(--text);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      padding: 10px 10px;
      font-size:13px;
      outline:none;
      min-width: 160px;
    }
    input[type="text"]{ min-width: 260px; flex:1; }
    .mini{
      font-size:12px; color: var(--muted);
      padding-top:6px;
    }

    .kpiItem{
      padding: 14px;
      border-radius: var(--r);
      border:1px solid rgba(255,255,255,.12);
      background: radial-gradient(600px 120px at 20% 0%, rgba(56,189,248,.15), transparent 60%),
                  radial-gradient(600px 120px at 80% 0%, rgba(168,85,247,.12), transparent 60%),
                  rgba(255,255,255,.035);
    }
    .kpiItem .label{ font-size:12px; color: var(--muted); }
    .kpiItem .value{ font-size: 22px; font-weight: 1000; letter-spacing:-0.6px; margin-top:6px; }
    .kpiItem .note{ font-size:12px; color: var(--muted); margin-top:6px; }

    .kpiRow{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      margin-top:6px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid rgba(255,255,255,.14);
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      background: rgba(255,255,255,.04);
      color: var(--muted);
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: #fff;
      box-shadow: 0 0 0 3px rgba(255,255,255,.10);
    }

    .warnBox{
      display:none;
      margin-top:10px;
      border:1px solid rgba(245,158,11,.35);
      background: rgba(245,158,11,.08);
      color: rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius: 14px;
      font-size:12px;
      line-height:1.5;
    }

    canvas{
      width:100% !important;
      height: 320px !important;
    }

    /* Table */
    .tableWrap{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      overflow:auto;
      max-height: 460px;
      background: rgba(3,8,24,.35);
    }
    table{ width:100%; border-collapse:collapse; }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:12.5px;
      white-space:nowrap;
    }
    th{
      position:sticky; top:0;
      background: rgba(5,8,22,.92);
      text-align:left;
      font-weight:900;
      z-index:1;
    }
    tbody tr:hover td{
      background: rgba(255,255,255,.05);
    }
    .resPill{
      display:inline-flex; align-items:center; gap:8px;
      font-weight:900;
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
    }
    .resPill.ok{ color: var(--ok); }
    .resPill.wait{ color: var(--wait); }
    .resPill.bad{ color: var(--bad); }
    .muted{ color: var(--muted); }

    .footRow{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }
  </style>
</head>

<body>
<header>
  <div class="headerWrap">
    <div class="titleBlock">
      <h1>í•™êµ ìì²´ ì…ì‹œ ë°ì´í„° ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
      <div class="sub">
        ì—‘ì…€ ì—…ë¡œë“œ â†’ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ë¶„ì„í•©ë‹ˆë‹¤. <b>ì„œë²„ ì €ì¥ ì—†ìŒ</b> Â· í•©ê²©ë¥  = (í•©ê²© + ì¶©ì›í•©ê²©) / (ê²°ê³¼ ê¸°ì¬ ê±´)
      </div>
      <div class="schoolTag">
        <span class="chip">í•™êµ: <b id="tagSchool">-</b></span>
        <span class="chip">í•™ë…„ë„: <b id="tagYear">-</b></span>
        <span class="chip">ë°ì´í„° ê±´ìˆ˜: <b id="tagCount">0</b></span>
        <span class="chip">ì°¨íŠ¸ ì„ íƒ: <b id="tagChart">ì—†ìŒ</b></span>
      </div>
    </div>

    <div class="actions">
      <!-- template.xlsxëŠ” ë‚˜ì¤‘ì— ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤ -->
      <a class="btn ghost" href="template.xlsx" download title="template.xlsxë¥¼ ì €ì¥ì†Œì— ì˜¬ë¦¬ë©´ ë°”ë¡œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤">ğŸ“¥ ì…ë ¥ìš© ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</a>

      <input id="file" type="file" accept=".xlsx,.xls" />
      <label for="file" class="btn primary">ğŸ“ ì—‘ì…€ ì—…ë¡œë“œ</label>

      <button class="btn ghost" id="btnReset">ì´ˆê¸°í™”</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- Filters -->
  <section class="card">
    <div class="cardHeader">
      <div>
        <h2>í•„í„°</h2>
        <div class="help">ì§€ì—­/ì „í˜•ìœ í˜•/ë“±ê¸‰ê¸°ì¤€ì„ ë°”ê¾¸ê±°ë‚˜, ì°¨íŠ¸ë¥¼ í´ë¦­í•˜ë©´ ì•„ë˜ ì‚¬ë¡€ê°€ í•¨ê»˜ í•„í„°ë§ë©ë‹ˆë‹¤.</div>
      </div>
      <div class="help" id="loadedHint">ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ë©´ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.</div>
    </div>

    <div class="filters">
      <select id="fYear" title="í•™ë…„ë„(ì „ì²´)"><option value="">í•™ë…„ë„(ì „ì²´)</option></select>
      <select id="fSchool" title="ê³ êµëª…(ì „ì²´)"><option value="">ê³ êµëª…(ì „ì²´)</option></select>

      <select id="fRegion" title="ì§€ì—­(ì „ì²´)"><option value="">ì§€ì—­(ì „ì²´)</option></select>
      <select id="fAdType" title="ì „í˜•ìœ í˜•(ì „ì²´)"><option value="">ì „í˜•ìœ í˜•(ì „ì²´)</option></select>

      <select id="gradeBase" title="ë“±ê¸‰ ê¸°ì¤€">
        <option value="í™˜ì‚°ë“±ê¸‰">ë“±ê¸‰ ê¸°ì¤€: í™˜ì‚°ë“±ê¸‰</option>
        <option value="ì „êµê³¼">ë“±ê¸‰ ê¸°ì¤€: ì „êµê³¼</option>
        <option value="êµ­ì˜ìˆ˜">ë“±ê¸‰ ê¸°ì¤€: êµ­ì˜ìˆ˜</option>
        <option value="êµ­ì˜ìˆ˜ì‚¬">ë“±ê¸‰ ê¸°ì¤€: êµ­ì˜ìˆ˜ì‚¬</option>
        <option value="êµ­ì˜ìˆ˜ê³¼">ë“±ê¸‰ ê¸°ì¤€: êµ­ì˜ìˆ˜ê³¼</option>
      </select>

      <input id="q" type="text" placeholder="ì‚¬ë¡€ ê²€ìƒ‰ (ëŒ€í•™ëª…/ëª¨ì§‘ë‹¨ìœ„/ì „í˜•/ë¶ˆí•©ê²©ì‚¬ìœ  ë“±)" />

      <button class="btn ghost" id="btnClearChart">ì°¨íŠ¸ í•„í„° í•´ì œ</button>
      <button class="btn ghost" id="btnExport">ì‚¬ë¡€ CSV ì €ì¥</button>
    </div>

    <div class="warnBox" id="warn"></div>
    <div class="mini">
      â€» ìš”ì²­ ë°˜ì˜: <b>ëŒ€í•™ìœ í˜•, ëª¨ì§‘ì‹œê¸° ë“œë¡­ë‹¤ìš´ ì œê±°</b> Â· í•©ê²©/ì¶©ì›/ë¶ˆí•©ê²© ë¹„ìœ¨ + í•©ê²©ë¥  ë™ì‹œ í‘œê¸° Â· ì§€ì—­ ì„ íƒ ì‹œ <b>ëŒ€í•™ TOP10</b> ìë™ ê°±ì‹ 
    </div>
  </section>

  <!-- KPIs -->
  <section class="grid kpi">
    <div class="kpiItem">
      <div class="label">í•„í„° ì ìš© í›„ ê±´ìˆ˜</div>
      <div class="value" id="kCount">0</div>
      <div class="note">ë¶„ì„ ëŒ€ìƒ í–‰ ìˆ˜</div>
    </div>

    <div class="kpiItem">
      <div class="label">í•©ê²©ë¥ </div>
      <div class="value" id="kRate">-</div>
      <div class="kpiRow">
        <span class="pill"><span class="dot" style="background:var(--ok)"></span>í•©ê²© <b id="kPass">0</b></span>
        <span class="pill"><span class="dot" style="background:var(--wait)"></span>ì¶©ì› <b id="kWait">0</b></span>
        <span class="pill"><span class="dot" style="background:var(--bad)"></span>ë¶ˆí•© <b id="kFail">0</b></span>
      </div>
      <div class="note">í•©ê²©ë¥  = (í•©ê²©+ì¶©ì›í•©ê²©) / ê²°ê³¼ê¸°ì¬ê±´</div>
    </div>

    <div class="kpiItem">
      <div class="label">ì¶©ì›í•©ê²© ë¹„ìœ¨</div>
      <div class="value" id="kWaitRate">-</div>
      <div class="note">ì¶©ì›í•©ê²© / (í•©ê²©+ì¶©ì›í•©ê²©)</div>
    </div>

    <div class="kpiItem">
      <div class="label">í‰ê·  ë“±ê¸‰</div>
      <div class="value" id="kGrade">-</div>
      <div class="note"><span id="kGradeLabel">í™˜ì‚°ë“±ê¸‰</span> í‰ê·  (ë¯¸ê¸°ì¬ ì œì™¸)</div>
    </div>
  </section>

  <!-- Results + Trends -->
  <section class="grid two">
    <div class="card">
      <div class="cardHeader">
        <div>
          <h2>í•©ê²© / ì¶©ì›í•©ê²© / ë¶ˆí•©ê²© ë¹„ìœ¨</h2>
          <div class="help">ë„ë„› ì°¨íŠ¸: ê²°ê³¼ êµ¬ì„±ë¹„. (í•©ê²©ë¥  ê³„ì‚° ì‹œ ì¶©ì›í•©ê²© í¬í•¨)</div>
        </div>
        <div class="help">í´ë¦­ â†’ ì‚¬ë¡€ í•„í„°</div>
      </div>
      <canvas id="chResult"></canvas>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div>
          <h2>ì „í˜•ìœ í˜•ë³„ í•©ê²©ë¥  & ê²°ê³¼ ê·œëª¨</h2>
          <div class="help">ë¼ì¸(í•©ê²©ë¥ ) + ëˆ„ì  ë§‰ëŒ€(í•©ê²©/ì¶©ì›/ë¶ˆí•©ê²© ê±´ìˆ˜)</div>
        </div>
        <div class="help">í´ë¦­ â†’ ì „í˜•ìœ í˜• í•„í„°</div>
      </div>
      <canvas id="chAdType"></canvas>
    </div>
  </section>

  <section class="grid two">
    <div class="card">
      <div class="cardHeader">
        <div>
          <h2>ì§€ì—­ë³„ í•©ê²©ë¥  & ê²°ê³¼ ê·œëª¨</h2>
          <div class="help">ë¼ì¸(í•©ê²©ë¥ ) + ëˆ„ì  ë§‰ëŒ€(í•©ê²©/ì¶©ì›/ë¶ˆí•©ê²© ê±´ìˆ˜)</div>
        </div>
        <div class="help">í´ë¦­ â†’ ì§€ì—­ í•„í„°</div>
      </div>
      <canvas id="chRegion"></canvas>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div>
          <h2>ë“±ê¸‰ëŒ€ë³„ í•©ê²©ë¥ </h2>
          <div class="help">ë“±ê¸‰ ê¸°ì¤€ ì„ íƒ ê°€ëŠ¥ Â· ë¼ì¸(í•©ê²©ë¥ ) + ì˜ì—­</div>
        </div>
        <div class="help">í´ë¦­ â†’ ë“±ê¸‰ëŒ€ í•„í„°</div>
      </div>
      <canvas id="chGradeBand"></canvas>
    </div>
  </section>

  <!-- Region -> Univ Top10 + Reasons + Wait -->
  <section class="grid three">
    <div class="card">
      <div class="cardHeader">
        <div>
          <h2>ì§€ì—­ ì„ íƒ â†’ ëŒ€í•™ëª…ë³„ í•©ê²©ë¥  TOP10</h2>
          <div class="help">ì§€ì—­ í•„í„°ê°€ â€œì „ì²´â€ë©´ ìƒìœ„ 10ê°œ ëŒ€í•™ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.</div>
        </div>
        <div class="help">í´ë¦­ â†’ ëŒ€í•™ í•„í„°</div>
      </div>
      <canvas id="chUnivTop"></canvas>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div>
          <h2>ë¶ˆí•©ê²© ì‚¬ìœ  ë¶„ì„</h2>
          <div class="help">ì˜ˆ: ìµœì €ë¯¸ì¶©ì¡±, ì„œë¥˜, ë©´ì ‘ ë“± (ë¶ˆí•©ê²©ì‚¬ìœ  ì»¬ëŸ¼ ê¸°ë°˜)</div>
        </div>
        <div class="help">í´ë¦­ â†’ ì‚¬ìœ  í•„í„°</div>
      </div>
      <canvas id="chReason"></canvas>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div>
          <h2>í›„ë³´ìˆœìœ„ ë¶„í¬(ì¶”í•© íë¦„)</h2>
          <div class="help">ë²„í‚·(1~3, 4~10, 11~20, 21~50, 51+) ê¸°ì¤€</div>
        </div>
        <div class="help">í´ë¦­ â†’ í›„ë³´ ë²„í‚· í•„í„°</div>
      </div>
      <canvas id="chWait"></canvas>
    </div>
  </section>

  <!-- Boxplot-like -->
  <section class="card">
    <div class="cardHeader">
      <div>
        <h2>í•©ê²©ì ë“±ê¸‰ ë¶„í¬ (ë°•ìŠ¤í”Œë¡¯ ëŠë‚Œ)</h2>
        <div class="help">
          í˜„ì¬ ì„ íƒëœ ì¡°ê±´(í•„í„°+ì°¨íŠ¸ì„ íƒ) ê¸°ì¤€ìœ¼ë¡œ í•©ê²©ì(í•©ê²©/ì¶©ì›) ë“±ê¸‰ ë¶„í¬ë¥¼ ìš”ì•½í•©ë‹ˆë‹¤.
          <b>ìµœì†Œâ€“ìµœëŒ€</b> ë²”ìœ„ì™€ <b>Q1â€“Q3</b> ë°•ìŠ¤, <b>ì¤‘ì•™ê°’</b> í¬ì¸íŠ¸ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
        </div>
      </div>
      <div class="help">ë°ì´í„°ê°€ ì ìœ¼ë©´ í‘œì‹œê°€ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    </div>
    <canvas id="chBox"></canvas>
  </section>

  <!-- Cases -->
  <section class="card">
    <div class="cardHeader">
      <div>
        <h2>ì‚¬ë¡€ ëª©ë¡</h2>
        <div class="help">ì°¨íŠ¸ í´ë¦­/í•„í„°/ê²€ìƒ‰ì–´ì— ë”°ë¼ ì•„ë˜ ì‚¬ë¡€ê°€ í•¨ê»˜ ê°±ì‹ ë©ë‹ˆë‹¤. (í‘œì‹œëŠ” ìµœëŒ€ 700í–‰)</div>
      </div>
      <div class="help muted" id="caseMeta">-</div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>í•™ë…„ë„</th>
            <th>ê³ êµëª…</th>
            <th>ì§€ì—­</th>
            <th>ëŒ€í•™ëª…</th>
            <th>ì „í˜•ìœ í˜•</th>
            <th>ì „í˜•</th>
            <th>ì„¸ë¶€ìœ í˜•</th>
            <th>ëª¨ì§‘ë‹¨ìœ„</th>
            <th>ìµœì €í•™ë ¥ê¸°ì¤€</th>
            <th>ë“±ê¸‰</th>
            <th>í™˜ì‚°ì ìˆ˜</th>
            <th>í•©ê²©ê²°ê³¼</th>
            <th>ë¶ˆí•©ê²©ì‚¬ìœ </th>
            <th>í›„ë³´ìˆœìœ„</th>
            <th>ë“±ë¡ì—¬ë¶€</th>
            <th>ë¹„ê³ </th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="footRow">
      <div class="help">â€» ê°œì¸ì •ë³´(í•™ìƒë²ˆí˜¸ ë“±)ëŠ” í‘œì— í‘œì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‚´ë¶€ ê³µìœ  ì‹œì—ë„ ìœ ì˜í•˜ì„¸ìš”.</div>
      <div class="help">í‘œ ë‚´ ìˆ«ì/í…ìŠ¤íŠ¸ëŠ” ì—…ë¡œë“œëœ ì—‘ì…€ ê°’ì„ ê·¸ëŒ€ë¡œ ë°˜ì˜í•©ë‹ˆë‹¤.</div>
    </div>
  </section>
</main>

<script>
/* =========================
   0) ì•ˆì „í•œ íŒŒì‹±(ì¤‘ë³µ í—¤ë”, Uì—´)
   ========================= */
const COLORS = {
  ok: getCss('--ok'),
  wait: getCss('--wait'),
  bad: getCss('--bad'),
  accent: getCss('--accent'),
  warn: getCss('--warn'),
  cyan: getCss('--cyan'),
  text: getCss('--text'),
  muted: getCss('--muted'),
};

function getCss(name){
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}

const COL = {
  year: "í•™ë…„ë„",
  school: "ê³ êµëª…",
  region: "ì§€ì—­",
  univ: "ëŒ€í•™ëª…",
  adType: "ì „í˜•ìœ í˜•",
  adName: "ì „í˜•",
  subType: "ì„¸ë¶€ìœ í˜•",
  major: "ëª¨ì§‘ë‹¨ìœ„",
  minReq: "ìµœì €í•™ë ¥ê¸°ì¤€",
  score: "í™˜ì‚°ì ìˆ˜",
  grade: "í™˜ì‚°ë“±ê¸‰",
  result: "í•©ê²©ê²°ê³¼",
  reason: "ë¶ˆí•©ê²©ì‚¬ìœ ",
  waitNo: "í›„ë³´ìˆœìœ„",
  reg: "ë“±ë¡ì—¬ë¶€",
  note: "ë¹„ê³ "
};

// Uì—´(21ë²ˆì§¸, 0-index 20) = í•©ê²©ê²°ê³¼ ê¸°ì¤€ (ì‚¬ìš©ì ìš”ì²­)
// í—¤ë”ëª…ì´ 'í•©ê²©ê²°ê³¼'ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„ . ì—†ìœ¼ë©´ Uì—´ ê°’ì„ ì‚¬ìš©.
const U_COL_INDEX = 20;

function norm(s){ return (s ?? "").toString().trim(); }
function normKey(s){ return norm(s).replace(/\s+/g,''); }
function toNum(v){
  const s = norm(v).replace(/,/g,'');
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}
function escapeHtml(s){
  return norm(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}
function isPass(res){
  const r = norm(res);
  return r === "í•©ê²©" || r === "ì¶©ì›í•©ê²©";
}
function isWait(res){
  return norm(res) === "ì¶©ì›í•©ê²©";
}
function isFail(res){
  return norm(res) === "ë¶ˆí•©ê²©";
}

function bucketWait(n){
  const v = toNum(n);
  if (v == null) return "ë¯¸ê¸°ì¬";
  if (v <= 3) return "1~3";
  if (v <= 10) return "4~10";
  if (v <= 20) return "11~20";
  if (v <= 50) return "21~50";
  return "51+";
}
function gradeBandFromValue(val){
  const v = toNum(val);
  if (v == null) return "ë¯¸ê¸°ì¬";
  const b = Math.floor(v);
  if (!Number.isFinite(b) || b <= 0) return "ë¯¸ê¸°ì¬";
  if (b >= 9) return "9ë“±ê¸‰ëŒ€";
  return `${b}ë“±ê¸‰ëŒ€`;
}

let RAW = [];        // ì „ì²´ ë ˆì½”ë“œ
let VIEW = [];       // ê¸°ë³¸ í•„í„° ì ìš© í›„
let chartFilter = null; // {type, value}
let charts = {};     // Chart instances

const el = (id)=>document.getElementById(id);
const warnEl = el('warn');

function showWarn(msg){
  if (!msg){
    warnEl.style.display = 'none';
    warnEl.textContent = '';
    return;
  }
  warnEl.style.display = 'block';
  warnEl.textContent = msg;
}

/* =========================
   1) ì—…ë¡œë“œ/ì´ˆê¸°í™”
   ========================= */
el('file').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if (!f) return;
  try{
    await loadExcel(f);
  }catch(err){
    console.error(err);
    showWarn('ì—‘ì…€ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (err?.message || err));
  }
});

el('btnReset').addEventListener('click', ()=>{
  RAW = [];
  VIEW = [];
  chartFilter = null;
  el('file').value = '';
  resetFilters();
  destroyCharts();
  refreshAll();
  el('loadedHint').textContent = 'ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ë©´ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.';
  el('tagSchool').textContent = '-';
  el('tagYear').textContent = '-';
  el('tagCount').textContent = '0';
  el('tagChart').textContent = 'ì—†ìŒ';
  showWarn('');
});

el('btnClearChart').addEventListener('click', ()=>{
  chartFilter = null;
  el('tagChart').textContent = 'ì—†ìŒ';
  refreshAll();
});

el('btnExport').addEventListener('click', exportCSV);

['fYear','fSchool','fRegion','fAdType','gradeBase','q'].forEach(id=>{
  el(id).addEventListener(id === 'q' ? 'input' : 'change', refreshAll);
});

function resetFilters(){
  el('fYear').innerHTML = `<option value="">í•™ë…„ë„(ì „ì²´)</option>`;
  el('fSchool').innerHTML = `<option value="">ê³ êµëª…(ì „ì²´)</option>`;
  el('fRegion').innerHTML = `<option value="">ì§€ì—­(ì „ì²´)</option>`;
  el('fAdType').innerHTML = `<option value="">ì „í˜•ìœ í˜•(ì „ì²´)</option>`;
  el('gradeBase').value = 'í™˜ì‚°ë“±ê¸‰';
  el('q').value = '';
}

async function loadExcel(file){
  showWarn('');
  const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf, {type:'array'});
  const ws = wb.Sheets[wb.SheetNames[0]];

  // ë°°ì—´ í˜•íƒœë¡œ ë¨¼ì € ì½ì–´ì„œ(ì¤‘ë³µí—¤ë”/ì—´ ì¸ë±ìŠ¤ ì ‘ê·¼ì„ ìœ„í•´)
  const aoa = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
  if (!aoa || aoa.length < 2){
    showWarn('ì‹œíŠ¸ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  const headersRaw = aoa[0].map(h=>norm(h));
  const headers = makeUniqueHeaders(headersRaw);

  // í—¤ë” ì¡´ì¬ ì—¬ë¶€ ì²´í¬
  const headerSet = new Set(headers.map(h=>normKey(h)));
  const required = [COL.year, COL.school, COL.region, COL.univ, COL.adType, COL.major].map(normKey);
  const missing = required.filter(k => !headerSet.has(k));
  if (missing.length){
    showWarn('í•„ìˆ˜ ì—´ ì¼ë¶€ê°€ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤(ì—´ ì´ë¦„ í™•ì¸ í•„ìš”): ' + missing.join(', '));
  }

  // ë ˆì½”ë“œ ìƒì„±
  const rows = [];
  for (let i=1; i<aoa.length; i++){
    const rowArr = aoa[i];
    // ë¹ˆí–‰ ìŠ¤í‚µ(ì£¼ìš” í•„ë“œ ëª¨ë‘ ë¹„ë©´)
    const joined = rowArr.join('').trim();
    if (!joined) continue;

    const obj = {};
    for (let c=0; c<headers.length; c++){
      obj[headers[c]] = rowArr[c] ?? "";
    }
    // Uì—´ ê°’ ì €ì¥(ìš”ì²­: í•©ê²©ê²°ê³¼ëŠ” Uì—´)
    obj.__U = rowArr[U_COL_INDEX] ?? "";
    rows.push(obj);
  }

  // resultKey ê²°ì •: í•©ê²©ê²°ê³¼ í—¤ë” ìˆìœ¼ë©´ ê·¸ê±¸, ì—†ìœ¼ë©´ __U ì‚¬ìš©
  const resultKey = findKey(headers, COL.result);

  RAW = rows.map(r=>{
    const o = {...r};
    o.__result = resultKey ? r[resultKey] : r.__U; // ìµœì¢… í•©ê²©ê²°ê³¼
    return o;
  });

  chartFilter = null;
  el('tagChart').textContent = 'ì—†ìŒ';

  buildFilterOptions();
  initCharts();
  refreshAll();

  el('loadedHint').textContent = `ì—…ë¡œë“œë¨: ${file.name}`;
}

/* ì¤‘ë³µ í—¤ë”ë¥¼ ìœ ë‹ˆí¬í•˜ê²Œ ë§Œë“¤ê¸° */
function makeUniqueHeaders(list){
  const seen = new Map();
  return list.map(h=>{
    const base = h || 'ì»¬ëŸ¼';
    const key = normKey(base) || 'ì»¬ëŸ¼';
    const cnt = (seen.get(key) || 0) + 1;
    seen.set(key, cnt);
    return cnt === 1 ? base : `${base}_${cnt}`;
  });
}

/* í—¤ë”ì—ì„œ "í•©ê²©ê²°ê³¼"ì²˜ëŸ¼ baseNameê³¼ ì¼ì¹˜(ê³µë°± ì œê±°)í•˜ëŠ” í‚¤ ì°¾ê¸° */
function findKey(headers, baseName){
  const target = normKey(baseName);
  // exact normKey match first
  for (const h of headers){
    if (normKey(h) === target) return h;
  }
  // startsWith fallback
  for (const h of headers){
    if (normKey(h).startsWith(target)) return h;
  }
  return null;
}

/* =========================
   2) í•„í„° ì˜µì…˜ ë§Œë“¤ê¸°
   ========================= */
function uniqSorted(arr){
  const set = new Set(arr.map(norm).filter(x=>x!==""));
  return Array.from(set).sort((a,b)=>a.localeCompare(b,'ko'));
}

function fillSelect(selectEl, items, placeholder){
  const cur = selectEl.value;
  selectEl.innerHTML = '';
  const o0 = document.createElement('option');
  o0.value = '';
  o0.textContent = placeholder;
  selectEl.appendChild(o0);

  for (const v of items){
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    selectEl.appendChild(opt);
  }
  if ([...selectEl.options].some(o=>o.value===cur)) selectEl.value = cur;
}

function buildFilterOptions(){
  if (!RAW.length) return;

  const yearK = findKey(Object.keys(RAW[0]), COL.year) || COL.year;
  const schoolK = findKey(Object.keys(RAW[0]), COL.school) || COL.school;
  const regionK = findKey(Object.keys(RAW[0]), COL.region) || COL.region;
  const adTypeK = findKey(Object.keys(RAW[0]), COL.adType) || COL.adType;

  fillSelect(el('fYear'), uniqSorted(RAW.map(r=>r[yearK])), 'í•™ë…„ë„(ì „ì²´)');
  fillSelect(el('fSchool'), uniqSorted(RAW.map(r=>r[schoolK])), 'ê³ êµëª…(ì „ì²´)');
  fillSelect(el('fRegion'), uniqSorted(RAW.map(r=>r[regionK])), 'ì§€ì—­(ì „ì²´)');
  fillSelect(el('fAdType'), uniqSorted(RAW.map(r=>r[adTypeK])), 'ì „í˜•ìœ í˜•(ì „ì²´)');
}

/* =========================
   3) í•„í„° ì ìš© + KPI
   ========================= */
function applyBaseFilters(rows){
  if (!rows.length) return [];

  const sample = rows[0];
  const yearK = findKey(Object.keys(sample), COL.year) || COL.year;
  const schoolK = findKey(Object.keys(sample), COL.school) || COL.school;
  const regionK = findKey(Object.keys(sample), COL.region) || COL.region;
  const adTypeK = findKey(Object.keys(sample), COL.adType) || COL.adType;

  const q = norm(el('q').value).toLowerCase();

  return rows.filter(r=>{
    if (el('fYear').value && norm(r[yearK]) !== el('fYear').value) return false;
    if (el('fSchool').value && norm(r[schoolK]) !== el('fSchool').value) return false;
    if (el('fRegion').value && norm(r[regionK]) !== el('fRegion').value) return false;
    if (el('fAdType').value && norm(r[adTypeK]) !== el('fAdType').value) return false;

    if (q){
      const blob = Object.values(r).join(' ').toLowerCase();
      if (!blob.includes(q)) return false;
    }
    return true;
  });
}

function applyChartFilter(rows){
  if (!chartFilter) return rows;
  if (!rows.length) return rows;

  const sample = rows[0];
  const regionK = findKey(Object.keys(sample), COL.region) || COL.region;
  const adTypeK = findKey(Object.keys(sample), COL.adType) || COL.adType;
  const univK = findKey(Object.keys(sample), COL.univ) || COL.univ;
  const reasonK = findKey(Object.keys(sample), COL.reason) || COL.reason;

  if (chartFilter.type === 'result'){
    // result: í•©ê²©/ì¶©ì›í•©ê²©/ë¶ˆí•©ê²©/ë¯¸ê¸°ì¬
    return rows.filter(r=>{
      const v = norm(r.__result);
      if (!v && chartFilter.value === 'ë¯¸ê¸°ì¬') return true;
      return v === chartFilter.value;
    });
  }
  if (chartFilter.type === 'region'){
    return rows.filter(r=> norm(r[regionK]) === chartFilter.value);
  }
  if (chartFilter.type === 'adType'){
    return rows.filter(r=> norm(r[adTypeK]) === chartFilter.value);
  }
  if (chartFilter.type === 'univ'){
    return rows.filter(r=> norm(r[univK]) === chartFilter.value);
  }
  if (chartFilter.type === 'reason'){
    return rows.filter(r=> norm(r[reasonK]) === chartFilter.value);
  }
  if (chartFilter.type === 'waitBucket'){
    return rows.filter(r=> bucketWait(r[findKey(Object.keys(sample), COL.waitNo) || COL.waitNo]) === chartFilter.value);
  }
  if (chartFilter.type === 'gradeBand'){
    const basis = el('gradeBase').value;
    const k = findKey(Object.keys(sample), basis) || basis;
    return rows.filter(r => gradeBandFromValue(r[k]) === chartFilter.value);
  }
  return rows;
}

function setTags(rows){
  if (!rows.length){
    el('tagSchool').textContent = '-';
    el('tagYear').textContent = '-';
    el('tagCount').textContent = '0';
    return;
  }
  const sample = rows[0];
  const yearK = findKey(Object.keys(sample), COL.year) || COL.year;
  const schoolK = findKey(Object.keys(sample), COL.school) || COL.school;

  // ëŒ€í‘œê°’(ìµœë¹ˆ)ìœ¼ë¡œ í‘œì‹œ
  el('tagSchool').textContent = mode(rows.map(r=>norm(r[schoolK]))) || '-';
  el('tagYear').textContent = mode(rows.map(r=>norm(r[yearK]))) || '-';
  el('tagCount').textContent = rows.length.toLocaleString('ko-KR');
}

function mode(arr){
  const m = new Map();
  for (const x of arr){
    if (!x) continue;
    m.set(x, (m.get(x)||0)+1);
  }
  let best = '';
  let bestN = 0;
  for (const [k,v] of m.entries()){
    if (v > bestN){ bestN = v; best = k; }
  }
  return best;
}

function setKPIs(rows){
  const count = rows.length;
  el('kCount').textContent = count.toLocaleString('ko-KR');
  el('tagCount').textContent = count.toLocaleString('ko-KR');

  const withResult = rows.filter(r=> norm(r.__result) !== "");
  const den = withResult.length;

  const pass = withResult.filter(r=> norm(r.__result)==="í•©ê²©").length;
  const wait = withResult.filter(r=> norm(r.__result)==="ì¶©ì›í•©ê²©").length;
  const fail = withResult.filter(r=> norm(r.__result)==="ë¶ˆí•©ê²©").length;

  el('kPass').textContent = pass.toLocaleString('ko-KR');
  el('kWait').textContent = wait.toLocaleString('ko-KR');
  el('kFail').textContent = fail.toLocaleString('ko-KR');

  const rate = den ? ((pass+wait)/den*100) : null;
  el('kRate').textContent = rate==null ? '-' : rate.toFixed(1)+'%';

  const passTotal = pass+wait;
  const waitRate = passTotal ? (wait/passTotal*100) : null;
  el('kWaitRate').textContent = waitRate==null ? '-' : waitRate.toFixed(1)+'%';

  // avg grade
  const basis = el('gradeBase').value;
  el('kGradeLabel').textContent = basis;
  const key = rows.length ? (findKey(Object.keys(rows[0]), basis) || basis) : basis;
  const grades = rows.map(r=>toNum(r[key])).filter(v=>v!=null);
  if (grades.length){
    const avg = grades.reduce((a,b)=>a+b,0)/grades.length;
    el('kGrade').textContent = avg.toFixed(2);
  }else{
    el('kGrade').textContent = '-';
  }
}

/* =========================
   4) ì§‘ê³„ í•¨ìˆ˜
   ========================= */
function aggByKey(rows, keyGetter){
  // ë¶„ëª¨ = ê²°ê³¼ ê¸°ì¬(í•©/ì¶©/ë¶ˆ)
  const m = new Map();
  for (const r of rows){
    const res = norm(r.__result);
    if (!res) continue;
    const key = keyGetter(r);
    if (!key) continue;
    if (!m.has(key)) m.set(key, {key, pass:0, wait:0, fail:0, den:0});
    const o = m.get(key);
    o.den += 1;
    if (res === 'í•©ê²©') o.pass += 1;
    else if (res === 'ì¶©ì›í•©ê²©') o.wait += 1;
    else if (res === 'ë¶ˆí•©ê²©') o.fail += 1;
  }
  const arr = Array.from(m.values()).map(o=>{
    const rate = o.den ? ((o.pass+o.wait)/o.den*100) : 0;
    return {...o, rate};
  });
  return arr;
}

function topNByRateThenDen(arr, n){
  return [...arr].sort((a,b)=>{
    if (b.rate !== a.rate) return b.rate - a.rate;
    return (b.den||0) - (a.den||0);
  }).slice(0,n);
}

function sumResultCounts(rows){
  const withResult = rows.filter(r=> norm(r.__result) !== "");
  const pass = withResult.filter(r=> norm(r.__result)==="í•©ê²©").length;
  const wait = withResult.filter(r=> norm(r.__result)==="ì¶©ì›í•©ê²©").length;
  const fail = withResult.filter(r=> norm(r.__result)==="ë¶ˆí•©ê²©").length;
  const empty = rows.length - withResult.length;
  return {pass, wait, fail, empty, den: withResult.length};
}

/* =========================
   5) ì°¨íŠ¸ ìƒì„±/ê°±ì‹ 
   ========================= */
function destroyCharts(){
  for (const c of Object.values(charts)){
    try{ c.destroy(); }catch{}
  }
  charts = {};
}
function initCharts(){
  destroyCharts();
  charts.result = createResultDonut('chResult');
  charts.adType = createMixedRateStack('chAdType', 'adType');
  charts.region = createMixedRateStack('chRegion', 'region');
  charts.gradeBand = createGradeBandChart('chGradeBand');
  charts.univTop = createUnivTopChart('chUnivTop');
  charts.reason = createReasonChart('chReason');
  charts.wait = createWaitChart('chWait');
  charts.box = createBoxLike('chBox');
}

function createResultDonut(id){
  const ctx = el(id);
  return new Chart(ctx, {
    type:'doughnut',
    data:{
      labels:['í•©ê²©','ì¶©ì›í•©ê²©','ë¶ˆí•©ê²©','ë¯¸ê¸°ì¬'],
      datasets:[{
        data:[0,0,0,0],
        backgroundColor:[COLORS.ok, COLORS.wait, COLORS.bad, 'rgba(234,240,255,.20)'],
        borderColor:'rgba(255,255,255,.12)',
        borderWidth:1,
        hoverOffset:6
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{ position:'bottom', labels:{ color: COLORS.text } },
        tooltip:{
          callbacks:{
            label:(ctx)=>{
              const v = ctx.raw || 0;
              return `${ctx.label}: ${v.toLocaleString('ko-KR')}ê±´`;
            }
          }
        }
      },
      onClick:(evt, els)=>{
        if (!els?.length) return;
        const idx = els[0].index;
        const label = charts.result.data.labels[idx];
        setChartFilter('result', label);
      }
    }
  });
}

function createMixedRateStack(id, mode){
  const ctx = el(id);
  // mode: 'region' or 'adType'
  return new Chart(ctx, {
    data:{
      labels:[],
      datasets:[
        // stacked bars counts
        {type:'bar', label:'í•©ê²©(ê±´)', data:[], backgroundColor: alpha(COLORS.ok,.55), borderColor: alpha(COLORS.ok,.9), borderWidth:1, stack:'count'},
        {type:'bar', label:'ì¶©ì›í•©ê²©(ê±´)', data:[], backgroundColor: alpha(COLORS.wait,.55), borderColor: alpha(COLORS.wait,.9), borderWidth:1, stack:'count'},
        {type:'bar', label:'ë¶ˆí•©ê²©(ê±´)', data:[], backgroundColor: alpha(COLORS.bad,.50), borderColor: alpha(COLORS.bad,.9), borderWidth:1, stack:'count'},
        // line rate
        {type:'line', label:'í•©ê²©ë¥ (%)', data:[], yAxisID:'yRate',
         borderColor: COLORS.cyan, backgroundColor: alpha(COLORS.cyan,.18),
         tension:.35, fill:true, pointRadius:4, pointHoverRadius:6}
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        yCount:{
          type:'linear',
          position:'left',
          beginAtZero:true,
          stacked:true,
          ticks:{ color: alpha(COLORS.text,.85) },
          grid:{ color: 'rgba(255,255,255,.06)' }
        },
        yRate:{
          type:'linear',
          position:'right',
          beginAtZero:true,
          max:100,
          grid:{ drawOnChartArea:false },
          ticks:{ color: alpha(COLORS.text,.85), callback:(v)=>v+'%' }
        },
        x:{
          ticks:{ color: alpha(COLORS.text,.85) },
          grid:{ display:false }
        }
      },
      plugins:{
        legend:{ position:'bottom', labels:{ color: COLORS.text } },
        tooltip:{
          callbacks:{
            afterBody:(items)=>{
              // show derived stats
              const i = items?.[0]?.dataIndex;
              const label = items?.[0]?.label;
              if (i == null || !label) return '';
              const pass = charts[mode]?.data?.datasets?.[0]?.data?.[i] ?? 0;
              const wait = charts[mode]?.data?.datasets?.[1]?.data?.[i] ?? 0;
              const fail = charts[mode]?.data?.datasets?.[2]?.data?.[i] ?? 0;
              const den = pass+wait+fail;
              const rate = den ? ((pass+wait)/den*100) : 0;
              const waitRate = (pass+wait) ? (wait/(pass+wait)*100) : 0;
              return `ê²°ê³¼ê¸°ì¬: ${den}ê±´\ní•©ê²©ë¥ : ${rate.toFixed(1)}%\nì¶©ì›ë¹„ìœ¨: ${waitRate.toFixed(1)}%`;
            }
          }
        }
      },
      interaction:{ mode:'index', intersect:false },
      onClick:(evt, els)=>{
        if (!els?.length) return;
        const idx = els[0].index;
        const label = charts[mode].data.labels[idx];
        setChartFilter(mode, label);
      }
    }
  });
}

function createGradeBandChart(id){
  const ctx = el(id);
  return new Chart(ctx, {
    type:'line',
    data:{
      labels:[],
      datasets:[
        {label:'í•©ê²©ë¥ (%)', data:[],
         borderColor: COLORS.accent,
         backgroundColor: alpha(COLORS.accent,.18),
         tension:.35,
         fill:true,
         pointRadius:5,
         pointHoverRadius:7
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        y:{
          beginAtZero:true, max:100,
          ticks:{ color: alpha(COLORS.text,.85), callback:(v)=>v+'%' },
          grid:{ color:'rgba(255,255,255,.06)' }
        },
        x:{
          ticks:{ color: alpha(COLORS.text,.85) },
          grid:{ display:false }
        }
      },
      plugins:{
        legend:{ display:false },
        tooltip:{
          callbacks:{
            afterBody:(items)=>{
              const i = items?.[0]?.dataIndex;
              const label = items?.[0]?.label;
              if (i == null) return '';
              const den = (charts.gradeBand.__meta?.[label]?.den) || 0;
              const pass = (charts.gradeBand.__meta?.[label]?.pass) || 0;
              const wait = (charts.gradeBand.__meta?.[label]?.wait) || 0;
              const fail = (charts.gradeBand.__meta?.[label]?.fail) || 0;
              const rate = den ? ((pass+wait)/den*100) : 0;
              return `ê²°ê³¼ê¸°ì¬: ${den}ê±´\ní•©ê²©: ${pass} / ì¶©ì›: ${wait} / ë¶ˆí•©: ${fail}\ní•©ê²©ë¥ : ${rate.toFixed(1)}%`;
            }
          }
        }
      },
      onClick:(evt, els)=>{
        if (!els?.length) return;
        const idx = els[0].index;
        const label = charts.gradeBand.data.labels[idx];
        setChartFilter('gradeBand', label);
      }
    }
  });
}

function createUnivTopChart(id){
  const ctx = el(id);
  return new Chart(ctx, {
    data:{
      labels:[],
      datasets:[
        {type:'bar', label:'í•©ê²©ë¥ (%)', data:[],
         backgroundColor: alpha(COLORS.ok,.45),
         borderColor: alpha(COLORS.ok,.95),
         borderWidth:1,
         yAxisID:'yRate'
        },
        {type:'line', label:'í•©ê²©ë¥  ì¶”ì„¸ì„ ', data:[],
         borderColor: COLORS.cyan,
         backgroundColor: alpha(COLORS.cyan,.12),
         tension:.25,
         pointRadius:3,
         yAxisID:'yRate'
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        yRate:{
          beginAtZero:true, max:100,
          ticks:{ color: alpha(COLORS.text,.85), callback:(v)=>v+'%' },
          grid:{ color:'rgba(255,255,255,.06)' }
        },
        x:{
          ticks:{ color: alpha(COLORS.text,.85) },
          grid:{ display:false }
        }
      },
      plugins:{
        legend:{ position:'bottom', labels:{ color: COLORS.text } },
        tooltip:{
          callbacks:{
            afterBody:(items)=>{
              const i = items?.[0]?.dataIndex;
              const label = items?.[0]?.label;
              if (i == null) return '';
              const meta = charts.univTop.__meta?.[label];
              if (!meta) return '';

              const pass = meta.pass ?? 0;
              const wait = meta.wait ?? 0;
              const fail = meta.fail ?? 0;
              const total = meta.total ?? (pass + wait + fail);
              const rate = total
                ? (((pass + wait) / total) * 100).toFixed(1)
                : '0.0';

              return [
                `í•©ê²©: ${pass}ê±´`,
                `ì¶©ì›í•©ê²©: ${wait}ê±´`,
                `ë¶ˆí•©ê²©: ${fail}ê±´`,
                `í•©ê²©ë¥ (í•©ê²©+ì¶©ì›): ${rate}%`
              ];
            }
          }
        }
      },
      onClick: (evt, elements) => {
        if (!elements || !elements.length) return;

        const idx = elements[0].index;
        const label = evt.chart.data.labels[idx];
        if (!label) return;

        // ëŒ€í•™ í´ë¦­ â†’ ì‚¬ë¡€ í•„í„° ê³ ì •
        chartFilter = {
          type: 'univ',
          value: label
        };

        const chip = document.getElementById('activeChip');
        if (chip) {
          chip.textContent = `ì°¨íŠ¸ ì„ íƒ: ëŒ€í•™ëª… = ${label}`;
        }

        refresh();
      }
    }
  });
}
function createAdTypeChart(id){
  const ctx = el(id);
  return new Chart(ctx, {
    data:{
      labels:[],
      datasets:[
        {type:'bar', label:'í•©ê²©ë¥ (%)', data:[],
         backgroundColor: alpha(COLORS.cyan,.45),
         borderColor: alpha(COLORS.cyan,.95),
         borderWidth:1,
         yAxisID:'yRate'
        },
        {type:'line', label:'í•©ê²©ë¥  ì¶”ì„¸ì„ ', data:[],
         borderColor: COLORS.ok,
         backgroundColor: alpha(COLORS.ok,.12),
         tension:.25,
         pointRadius:3,
         yAxisID:'yRate'
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        yRate:{
          beginAtZero:true, max:100,
          ticks:{ color: alpha(COLORS.text,.85), callback:v=>v+'%' },
          grid:{ color:'rgba(255,255,255,.06)' }
        },
        x:{
          ticks:{ color: alpha(COLORS.text,.85) },
          grid:{ display:false }
        }
      },
      plugins:{
        legend:{ position:'bottom', labels:{ color: COLORS.text } },
        tooltip:{
          callbacks:{
            afterBody:(items)=>{
              const label = items?.[0]?.label;
              if (!label) return '';
              const meta = charts.adType.__meta?.[label];
              if (!meta) return '';

              const pass = meta.pass ?? 0;
              const wait = meta.wait ?? 0;
              const fail = meta.fail ?? 0;
              const total = meta.total ?? (pass + wait + fail);
              const rate = total ? (((pass+wait)/total)*100).toFixed(1) : '0.0';

              return [
                `í•©ê²©: ${pass}ê±´`,
                `ì¶©ì›í•©ê²©: ${wait}ê±´`,
                `ë¶ˆí•©ê²©: ${fail}ê±´`,
                `í•©ê²©ë¥ (í•©ê²©+ì¶©ì›): ${rate}%`
              ];
            }
          }
        }
      },
      onClick:(evt,elements)=>{
        if(!elements?.length) return;
        const label = evt.chart.data.labels[elements[0].index];
        if(!label) return;

        chartFilter = { type:'adType', value: label };
        document.getElementById('activeChip').textContent =
          `ì°¨íŠ¸ ì„ íƒ: ì „í˜•ìœ í˜• = ${label}`;
        refresh();
      }
    }
  });
}
function createRegionChart(id){
  const ctx = el(id);
  return new Chart(ctx, {
    data:{
      labels:[],
      datasets:[
        {type:'bar', label:'í•©ê²©ë¥ (%)', data:[],
         backgroundColor: alpha(COLORS.blue,.45),
         borderColor: alpha(COLORS.blue,.95),
         borderWidth:1,
         yAxisID:'yRate'
        },
        {type:'line', label:'í•©ê²©ë¥  ì¶”ì„¸ì„ ', data:[],
         borderColor: COLORS.cyan,
         backgroundColor: alpha(COLORS.cyan,.12),
         tension:.25,
         pointRadius:3,
         yAxisID:'yRate'
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        yRate:{
          beginAtZero:true, max:100,
          ticks:{ color: alpha(COLORS.text,.85), callback:v=>v+'%' },
          grid:{ color:'rgba(255,255,255,.06)' }
        },
        x:{
          ticks:{ color: alpha(COLORS.text,.85) },
          grid:{ display:false }
        }
      },
      plugins:{
        legend:{ position:'bottom', labels:{ color: COLORS.text } },
        tooltip:{
          callbacks:{
            afterBody:(items)=>{
              const label = items?.[0]?.label;
              if (!label) return '';
              const meta = charts.region.__meta?.[label];
              if (!meta) return '';

              const pass = meta.pass ?? 0;
              const wait = meta.wait ?? 0;
              const fail = meta.fail ?? 0;
              const total = meta.total ?? (pass + wait + fail);
              const rate = total ? (((pass+wait)/total)*100).toFixed(1) : '0.0';

              return [
                `í•©ê²©: ${pass}ê±´`,
                `ì¶©ì›í•©ê²©: ${wait}ê±´`,
                `ë¶ˆí•©ê²©: ${fail}ê±´`,
                `í•©ê²©ë¥ (í•©ê²©+ì¶©ì›): ${rate}%`
              ];
            }
          }
        }
      },
      onClick:(evt,elements)=>{
        if(!elements?.length) return;
        const label = evt.chart.data.labels[elements[0].index];
        if(!label) return;

        chartFilter = { type:'region', value: label };
        document.getElementById('activeChip').textContent =
          `ì°¨íŠ¸ ì„ íƒ: ì§€ì—­ = ${label}`;
        refresh();
      }
    }
  });
}
function createGradeBandChart(id){
  const ctx = el(id);
  return new Chart(ctx, {
    data:{
      labels:[],
      datasets:[
        {type:'line', label:'í•©ê²©ë¥ (%)', data:[],
         borderColor: COLORS.purple,
         backgroundColor: alpha(COLORS.purple,.25),
         fill:true,
         tension:.35,
         pointRadius:4
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        y:{
          beginAtZero:true, max:100,
          ticks:{ color: alpha(COLORS.text,.85), callback:v=>v+'%' },
          grid:{ color:'rgba(255,255,255,.06)' }
        },
        x:{
          ticks:{ color: alpha(COLORS.text,.85) },
          grid:{ display:false }
        }
      },
      plugins:{
        legend:{ position:'bottom', labels:{ color: COLORS.text } },
        tooltip:{
          callbacks:{
            afterBody:(items)=>{
              const label = items?.[0]?.label;
              if (!label) return '';
              const meta = charts.gradeBand.__meta?.[label];
              if (!meta) return '';

              const pass = meta.pass ?? 0;
              const wait = meta.wait ?? 0;
              const fail = meta.fail ?? 0;
              const total = meta.total ?? (pass + wait + fail);
              const rate = total ? (((pass+wait)/total)*100).toFixed(1) : '0.0';

              return [
                `í•©ê²©: ${pass}ê±´`,
                `ì¶©ì›í•©ê²©: ${wait}ê±´`,
                `ë¶ˆí•©ê²©: ${fail}ê±´`,
                `í•©ê²©ë¥ (í•©ê²©+ì¶©ì›): ${rate}%`
              ];
            }
          }
        }
      },
      onClick:(evt,elements)=>{
        if(!elements?.length) return;
        const label = evt.chart.data.labels[elements[0].index];
        if(!label) return;

        chartFilter = { type:'gradeBand', value: label };
        document.getElementById('activeChip').textContent =
          `ì°¨íŠ¸ ì„ íƒ: ë“±ê¸‰ëŒ€ = ${label}`;
        refresh();
      }
    }
  });
}
